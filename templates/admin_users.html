{% extends "admin_base.html" %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">Users</h1>
  <p class="page-subtitle">Manage team members and their update preferences</p>
</div>
<!-- Search and Add User Section -->
<div class="row">
  <div class="col card">
    <div class="card-header">
      <h3 class="card-title">Search Users</h3>
    </div>
    <form method="get" style="display:flex;gap:12px;align-items:end">
      <div style="flex:1">
        <label>Search</label>
        <input type="text" name="q" placeholder="Search by name, email, or Slack ID…" value="{{ q or '' }}">
      </div>
      <button class="btn">Search</button>
      <a class="btn" href="/admin/users">Reset</a>
    </form>
  </div>

  <div class="col card">
    <div class="card-header">
      <h3 class="card-title">Add New User</h3>
    </div>
    <form method="post" action="/admin/users/new">
      <div class="row">
        <div class="col">
          <label>Slack User ID</label>
          <input name="slack_user_id" placeholder="e.g. U012AB3CDE" required>
          <small>Slack: open profile → ••• → <em>Copy member ID</em></small>
        </div>
        <div class="col">
          <label>Display Name</label>
          <input name="display_name" placeholder="Optional – defaults to Slack ID">
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Email</label>
          <input name="email" placeholder="Optional">
        </div>
        <div class="col">
          <label>Timezone</label>
          <input name="timezone" value="Europe/London" placeholder="IANA e.g. Europe/London">
        </div>
        <div class="col">
          <label>Cadence (days)</label>
          <input name="cadence_days" type="number" min="1" value="7">
        </div>
      </div>
      <div style="margin-top:16px">
        <button class="btn primary">Add User</button>
      </div>
    </form>
  </div>
</div>

<!-- Users Table -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">Team Members</h3>
  </div>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Slack ID</th>
        <th>Email</th>
        <th>Timezone</th>
        <th>Cadence</th>
        <th>Last Prompt</th>
        <th>Next Due</th>
        <th>Last Summary</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for r in rows %}
      <tr>
        <td>
          <a href="/admin/users/{{ r.id }}" style="color:#2383e2;text-decoration:none;font-weight:500">
            {{ r.display_name }}
          </a>
        </td>
        <td><code>{{ r.slack_user_id }}</code></td>
        <td>{{ r.email or '—' }}</td>
        <td>{{ r.timezone or '—' }}</td>
        <td>{{ r.cadence_days }}d</td>
        <td>{{ r.last_prompt_at or '—' }}</td>
        <td>{{ r.next_due_at or '—' }}</td>
        <td>
          {% if r.last_summary %}
            <div style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{ r.last_summary }}">
              {{ r.last_summary }}
            </div>
          {% else %}
            —
          {% endif %}
        </td>
        <td>
          <span class="badge {{ 'green' if r.is_active else 'amber' }}">
            {{ 'Active' if r.is_active else 'Paused' }}
          </span>
        </td>
        <td>
          <div style="display:flex;gap:8px">
            <form class="inline" method="post" action="/admin/users/{{ r.id }}/chase">
              <button class="btn primary">Chase</button>
            </form>
            <form class="inline" method="post" action="/admin/users/{{ r.id }}/toggle">
              <button class="btn">{{ 'Pause' if r.is_active else 'Resume' }}</button>
            </form>
          </div>
        </td>
      </tr>
    {% else %}
      <tr>
        <td colspan="10" class="empty-state">
          <h3>No users yet</h3>
          <p>Add your first team member using the form above</p>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
